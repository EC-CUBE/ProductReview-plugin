{#
/*
 * This file is part of the ProductReview plugin
 *
 * Copyright (C) 2016 LOCKON CO.,LTD. All Rights Reserved.
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
#}
{#
[商品管理]-[商品レビュー]-[一覧・検索]画面
#}

{% extends '@admin/styleguide_frame.twig' %}

{% set menus = ['product', 'product_review'] %}
{% block title %}{{ 'plugin.admin.product.management.title'|trans }}{% endblock %}
{% block sub_title %}{{ 'plugin.admin.product_review.form.product'|trans }}{% endblock %}

{% form_theme searchForm '@admin/Form/bootstrap_4_layout.html.twig' %}

{% block stylesheet %}
<link rel="stylesheet" href="{{ asset('assets/css/bootstrap-datetimepicker.min.css', 'admin') }}">
{% endblock stylesheet %}

{% block javascript %}
<script src="{{ asset('assets/js/vendor/moment.min.js', 'admin') }}"></script>
<script src="{{ asset('assets/js/vendor/moment-ja.js', 'admin') }}"></script>
<script src="{{ asset('assets/js/vendor/bootstrap-datetimepicker.min.js', 'admin') }}"></script>
<script>
$(function() {
    $('#product_review_download').click(function(event) {
        event.preventDefault();
        var href = $(this).attr('href');
        fnChangeActionSubmit(href);
    });

    var inputDate = document.createElement('input');
    inputDate.setAttribute('type', 'date');
    if (inputDate.type !== 'date') {
        $('input[id$=_review_start]').datetimepicker({
            locale: 'ja',
            format: 'YYYY-MM-DD',
            useCurrent: false,
            showTodayButton: true
        });

        $('input[id$=_review_end]').datetimepicker({
            locale: 'ja',
            format: 'YYYY-MM-DD',
            useCurrent: false,
            showTodayButton: true
        });
    }
    // フォーム値を確認し、アコーディオンを制御
    // 値あり : 開く / 値なし : 閉じる
    (function($, f) {
        //フォームがないページは処理キャンセル
        var $ac = $(".accpanel");
        if (!$ac) {
            return false
        }
        //フォーム内全項目取得
        var c = f();
        if (c.formState()) {
            if ($ac.css("display") == "none") {
                $ac.parent('li').addClass("active");
                $ac.slideDown(0);
            }
        } else {
            $ac.parent('li').removeClass("active");
            $ac.slideUp(0);
        }
    })($, formPropStateSubscriber);
});
function fnChangeActionSubmit(action) {
    document.search_form.action = action;
    document.search_form.submit();
}
</script>
{% endblock javascript %}

{% block main %}
<!--検索条件設定テーブルここから-->
<div class="c-outsideBlock">
    <form name="search_form" id="search_form" method="post" action="">
        {{ form_widget(searchForm._token) }}
        <div class="c-outsideBlock__contents">
            <div class="row justify-content-start">
                <div class="col-6">
                    <div class="mb-2">
                        <label class="col-form-label">{{ 'admin.product.index.470'|trans }}</label>
                        {{ form_widget(searchForm.multi, { attr: { placeholder: 'plugin.admin.product_review.search.inputsearch.placeholder'|trans, class : 'input_search' } } ) }}
                    </div>
                    <div class="d-inline-block mb-3" data-toggle="collapse" href="#searchDetail"
                         aria-expanded="false" aria-controls="searchDetail"><a><i
                                    class="fa fa-plus-square-o font-weight-bold mr-1"></i><span
                                    class="font-weight-bold">{{ 'admin.product.index.detailed_search'|trans }}</span></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="c-subContents collapse ec-collapse" id="searchDetail">
            <div class="row mb-2">
                <div class="col-6 col-sm-4">
                    <label>{{ searchForm.product_name.vars.label }}</label>
                    <div class="form-group">{{ form_widget(searchForm.product_name) }}</div>
                </div>
                <div class="col-6 col-sm-4">
                    <label>{{ searchForm.product_code.vars.label }}</label>
                    <div class="form-group">{{ form_widget(searchForm.product_code) }}</div>
                </div>
                <div class="col-6 col-sm-4">
                    <label>{{ searchForm.recommend_level.vars.label }}</label>
                    <div class="form-group">{{ form_widget(searchForm.recommend_level) }}</div>
                </div>

                <div class="col-6 col-sm-4">
                    <label>{{ searchForm.review_start.vars.label }}</label>
                    <div class="form-group range">
                        {{ form_widget(searchForm.review_start, {'attr': {'class': 'input_cal'}}) }} ～ {{ form_widget(searchForm.review_end, {'attr': {'class': 'input_cal'}}) }}
                    </div>
                </div>

                <div class="col-6 col-sm-4">
                    <label>{{ searchForm.sex.vars.label }}</label>
                    <div class="form-group">{{ form_widget(searchForm.sex) }}</div>
                </div>

                <div class="col-6 col-sm-4">
                    <label>{{ searchForm.status.vars.label }}</label>
                    <div class="form-group">{{ form_widget(searchForm.status) }}</div>
                </div>
            </div>
            <div class="d-block text-center">
                <button class="btn btn-ec-regular search-clear"
                        type="button">{{ 'admin.product.index.477'|trans }}</button>
            </div>
        </div><!-- /.col -->
        <div class="c-outsideBlock__contents mb-5">
            <button class="btn btn-ec-conversion px-5" type="submit">{{ 'admin.product.index.478'|trans }}</button>
            {% if pagination %}
                <span id="search-result" class="font-weight-bold ml-2">{{'admin.product.index.479'|trans({"%count%":pagination.totalItemCount})|raw}}</span>
            {% endif %}
        </div>
    </form>
</div>
<!--検索条件設定テーブルここまで-->
<div class="c-contentsArea__cols">
    <div class="c-contentsArea__primaryCol">
        <div class="c-primaryCol">
            <div class="row justify-content-between mb-2">
                <div class="col-6">
                    &nbsp;
                </div>
                <div class="col-5 text-right">
                    <div class="d-inline-block mr-2">
                        <div>
                            <select class="custom-select" onchange="location = this.value;">
                                {% for pageMax in pageMaxis %}
                                    <option {% if pageMax.name == page_count %}selected=""{% endif %} value="{{ path('plugin_admin_product_review_page', {'page_no': 1, 'page_count': pageMax.name}) }}">{{ pageMax.name|e }}{{ 'admin.product.index.num'|trans }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="d-inline-block">
                        <div class="btn-group" role="group">
                            {# TODO onclickは適切ではないのでaタグで実装できるようにする #}
                            <button class="btn btn-ec-regular" type="button"
                                    onclick='location.href="{{ url('plugin_admin_product_review_download') }}"'><i
                                        class="fa fa-cloud-download mr-1 text-secondary"></i><span>{{ 'admin.product.index.484'|trans }}</span>
                            </button>
                            {# TODO onclickは適切ではないのでaタグで実装できるようにする #}
                            <button class="btn btn-ec-regular" type="button"
                                    onclick='location.href="{{ url('admin_setting_shop_csv', { id : csv_type }) }}"'>
                                <i
                                        class="fa fa-cog mr-1 text-secondary"></i><span>{{ 'admin.product.index.486'|trans }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card rounded border-0 mb-4">
                <div class="card-body p-0">
                    <table class="table table-sm">
                        <thead>
                        <tr>
                            <th class="text-center">ID</th>
                            <th>{{ 'plugin.admin.product_review.list.posted.date'|trans }}</th>
                            <th>{{ 'plugin.admin.product_review.list.contributor'|trans }}</th>
                            <th>{{ 'plugin.admin.product_review.list.product.name'|trans }}</th>
                            <th>{{ 'plugin.admin.product_review.list.title'|trans }}</th>
                            <th>{{ 'plugin.admin.product_review.list.level'|trans }}</th>
                            <th>{{ 'plugin.admin.product_review.list.status'|trans }}</th>
                            <th>&nbsp;</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for Review in pagination %}
                            <tr>
                                <td class="text-center">{{ Review.id }}</td>
                                <td>{{ Review.create_date|date('Y/m/d H:i') }}</td>
                                <td>{{ Review.reviewer_name }}</td>
                                <td>{{ Review.Product.name }}</td>
                                <td><a href="{{ url('plugin_admin_product_review_edit', { id : Review.id }) }}">{{ Review.title }}</a></td>
                                <td>{% for i in 1..Review.recommend_level %}★{% endfor %}</td>
                                <td>{{ Review.status }}</td>
                                <td class="icon_edit">
                                    <div class="col-auto text-right">
                                        <a href="{{ url('plugin_admin_product_review_edit', { id : Review.id }) }}"
                                           class="btn btn-ec-actionIcon mr-3 action-edit"
                                           data-toggle="tooltip"
                                           data-placement="top" title=""
                                           data-original-title="{{ 'plugin.admin.product_review.list.title.edit.name'|trans }}"><i class="fa fa-pencil fa-lg text-secondary"></i></a>

                                        <a
                                                class="btn btn-ec-actionIcon mr-3"
                                                data-toggle="modal"
                                                data-target="#confirmModal-{{ Review.id }}"
                                                data-toggle="tooltip"
                                                data-placement="top"
                                                title="{{ 'admin.product.tag.delete'|trans }}"><i
                                                    class="fa fa-close fa-lg text-secondary"></i></a>
                                    </div>
                                    <div class="modal fade" id="confirmModal-{{ Review.id }}" tabindex="-1"
                                         role="dialog"
                                         aria-labelledby="confirmModal-{{ Review.id }}" aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title font-weight-bold">
                                                        {{ 'admin.product.tag.delete.confirm.title'|trans }}</h5>
                                                    <button class="close" type="button"
                                                            data-dismiss="modal"
                                                            aria-label="Close"><span
                                                                aria-hidden="true">×</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body text-left">
                                                    <p class="text-left">
                                                        {{ 'admin.product.tag.delete.confirm.message'|trans }}</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button class="btn btn-ec-sub" type="button"
                                                            data-dismiss="modal">{{ 'admin.product.index.cancel'|trans }}
                                                    </button>
                                                    <a
                                                            href="{{ url('plugin_admin_product_review_delete', { id : Review.id }) }}"
                                                            class="btn btn-ec-delete"
                                                            data-confirm="false"
                                                            {{ csrf_token_for_anchor() }}
                                                            data-method="delete">
                                                        {{ 'admin.product.index.delete'|trans }}
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="row justify-content-md-center mb-4">
                    {% if pagination|length > 0 %}
                        {% include "@admin/styleguide_pager.twig" with { 'pages' : pagination.paginationData, 'routes' : 'plugin_admin_product_review_page' } %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
